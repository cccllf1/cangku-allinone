<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>åº“å­˜ç®¡ç† - PDAä¸“ç”¨</title>
<!-- æ·»åŠ vConsoleè°ƒè¯•å·¥å…· -->
<script src="https://cdn.jsdelivr.net/npm/vconsole@latest/dist/vconsole.min.js"></script>
<script>
  // åˆå§‹åŒ–vConsole
  var vConsole = new VConsole();
  console.log('vConsole å·²å¯ç”¨');
</script>
<style>
body {
  margin: 0;
  padding: 10px;
  font-family: sans-serif;
  background: #f0f2f5;
}
h1 {
  text-align: center;
  font-size: 20px;
  margin: 15px 0;
  color: #1890ff;
}
.search {
  width: calc(100% - 50px);
  height: 40px;
  padding: 5px 10px;
  border: 1px solid #d9d9d9;
  border-radius: 4px 0 0 4px;
  font-size: 16px;
  margin-bottom: 10px;
}
.search-btn {
  width: 50px;
  height: 52px;
  background: #1890ff;
  color: white;
  border: none;
  border-radius: 0 4px 4px 0;
  font-size: 18px;
  vertical-align: bottom;
}
.btn {
  display: block;
  width: 100%;
  background: #1890ff;
  color: white;
  text-align: center;
  padding: 10px 0;
  font-size: 16px;
  margin-bottom: 10px;
  border: none;
  border-radius: 4px;
}
.item {
  background: white;
  border: 1px solid #eee;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 4px;
  display: flex;
  align-items: center;
}
.item-image {
  width: 60px;
  height: 60px;
  background: #f5f5f5;
  margin-right: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.item-content {
  flex: 1;
}
.back {
  margin-top: 20px;
  background: #999;
}
.product-name {
  font-weight: bold;
  font-size: 16px;
  margin-bottom: 4px;
}
.product-code {
  color: #999;
  font-size: 12px;
  margin-bottom: 4px;
}
.tags {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}
.tag {
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 12px;
  display: inline-block;
}
.tag-blue {
  background: #e6f7ff;
  color: #1890ff;
  border: 1px solid #91d5ff;
}
.tag-green {
  background: #f6ffed;
  color: #52c41a;
  border: 1px solid #b7eb8f;
}
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1000;
}
.modal-content {
  position: relative;
  width: 100%;
  height: 100%;
  background: white;
  overflow-y: auto;
}
.modal-header {
  padding: 15px;
  border-bottom: 1px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-title {
  font-size: 18px;
  font-weight: bold;
}
.modal-close {
  font-size: 24px;
  border: none;
  background: transparent;
  cursor: pointer;
}
.modal-body {
  padding: 15px;
}
.section-title {
  font-weight: bold;
  margin: 15px 0 5px 0;
  color: #555;
}
.api-test {
  padding: 10px;
  margin: 10px 0;
  border-radius: 4px;
  border: 1px solid #f0f0f0;
  background: #f5f5f5;
}
.error {
  background: #fff2f0;
  border: 1px solid #ffccc7;
  color: #f5222d;
}
.success {
  background: #f6ffed;
  border: 1px solid #b7eb8f;
  color: #52c41a;
}
.warning {
  background: #fffbe6;
  border: 1px solid #ffe58f;
  color: #faad14;
}
.location-item {
  padding: 10px;
  border: 1px solid #f0f0f0;
  margin-bottom: 8px;
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.location-qty {
  font-size: 16px;
  font-weight: bold;
  color: #52c41a;
  background: #f6ffed;
  padding: 2px 8px;
  border-radius: 12px;
}
.sku-item {
  padding: 10px;
  border: 1px solid #f0f0f0;
  margin-bottom: 8px;
  border-radius: 4px;
}
.sku-title {
  font-weight: bold;
  margin-bottom: 5px;
  font-size: 14px;
}
.sku-variants {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 8px;
}
.sku-variant {
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 12px;
  background: #f0f5ff;
  color: #1890ff;
  border: 1px solid #d6e4ff;
}
</style>
</head>
<body>
<h1>åº“å­˜ç®¡ç†</h1>

<!-- APIçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ - é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯• -->
<div id="apiStatus" class="api-test">
  æ­£åœ¨æ£€æŸ¥APIè¿æ¥çŠ¶æ€...
</div>

<div style="display: flex;">
  <input type="text" class="search" placeholder="è¾“å…¥å•†å“ç¼–ç æˆ–åç§°" id="searchInput">
  <button class="search-btn" onclick="searchProduct()">ğŸ”</button>
</div>

<div id="results">
  <!-- å•†å“åˆ—è¡¨ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
</div>

<button class="btn back" onclick="location.href='/pda-simple.html'">è¿”å›ä¸»èœå•</button>

<!-- å•†å“è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">å•†å“è¯¦æƒ…</div>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-body" id="modalContent">
      <!-- è¯¦æƒ…å†…å®¹ä¼šåŠ¨æ€å¡«å…… -->
    </div>
  </div>
</div>

<script>
// å…¨å±€å˜é‡å­˜å‚¨å•†å“æ•°æ®
var productsList = [];

// é¡µé¢åŠ è½½æ—¶ç«‹å³æ£€æŸ¥API
window.onload = function() {
  var statusDiv = document.getElementById('apiStatus');
  var resultsDiv = document.getElementById('results');
  
  // æµ‹è¯•APIç¯å¢ƒä¿¡æ¯
  var info = {
    'URL': window.location.href,
    'ç”¨æˆ·ä»£ç†': navigator.userAgent,
    'PDAä¿¡æ¯': 'ç»ˆç«¯ç±»å‹: ' + (navigator.platform || 'unknown')
  };
  
  var infoText = 'è®¾å¤‡ä¿¡æ¯:<br>';
  for (var key in info) {
    infoText += key + ': ' + info[key] + '<br>';
  }
  
  statusDiv.innerHTML = infoText + '<br>æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...';
  
  // ç›´æ¥è·å–åº“å­˜æ•°æ®
  try {
    var token = localStorage.getItem('token') || 'pda-direct-access-token';
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/inventory/', true);
    xhr.timeout = 10000; // 10ç§’è¶…æ—¶
    xhr.setRequestHeader('Authorization', 'Bearer ' + token);
    xhr.setRequestHeader('Content-Type', 'application/json');
    
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4) {
        if (xhr.status === 200) {
          statusDiv.innerHTML = infoText + '<br>âœ… åº“å­˜æ•°æ®åŠ è½½æˆåŠŸ!';
          statusDiv.className = 'api-test success';
          
          try {
            // è§£ææ•°æ®
            var data = JSON.parse(xhr.responseText);
            
            if (data && data.length > 0) {
              statusDiv.innerHTML += '<br>è·å–åˆ° ' + data.length + ' æ¡åº“å­˜è®°å½•';
              
              // ä¿å­˜æ•°æ®
              productsList = data;
              
              // æ¸²æŸ“åˆ—è¡¨è§†å›¾
              renderProductList(data);
            } else {
              statusDiv.innerHTML += '<br>APIè¿”å›äº†ç©ºæ•°æ®';
              statusDiv.className = 'api-test warning';
            }
          } catch (parseError) {
            statusDiv.innerHTML += '<br>âŒ è§£ææ•°æ®å‡ºé”™: ' + parseError.message;
            statusDiv.className = 'api-test error';
            
            // æ˜¾ç¤ºåŸå§‹å“åº”ä»¥ä¾¿è°ƒè¯•
            var responsePreview = xhr.responseText;
            if (responsePreview.length > 100) {
              responsePreview = responsePreview.substring(0, 100) + '...';
            }
            
            statusDiv.innerHTML += '<br>APIå“åº”é¢„è§ˆ: ' + responsePreview;
          }
        } else {
          statusDiv.innerHTML = infoText + '<br>âŒ åº“å­˜APIè¯·æ±‚å¤±è´¥: ' + xhr.status + ' ' + xhr.statusText;
          statusDiv.className = 'api-test error';
        }
      }
    };
    
    xhr.ontimeout = function() {
      statusDiv.innerHTML = infoText + '<br>âš ï¸ åº“å­˜APIè¯·æ±‚è¶…æ—¶';
      statusDiv.className = 'api-test warning';
    };
    
    xhr.onerror = function() {
      statusDiv.innerHTML = infoText + '<br>âŒ åº“å­˜APIç½‘ç»œé”™è¯¯';
      statusDiv.className = 'api-test error';
    };
    
    xhr.send();
  } catch (e) {
    statusDiv.innerHTML = infoText + '<br>âŒ è¯·æ±‚å‡ºé”™: ' + e.message;
    statusDiv.className = 'api-test error';
  }
};

// æ¸²æŸ“å•†å“åˆ—è¡¨
function renderProductList(products) {
  var resultsDiv = document.getElementById('results');
  resultsDiv.innerHTML = '';
  
  products.forEach(function(product, index) {
    var html = '<div class="item" onclick="showProductDetail(' + index + ')">';
    
    html += '<div class="item-image">';
    if (product.image) {
      html += '<img src="' + product.image + '" alt="å•†å“å›¾ç‰‡" style="max-width: 100%; max-height: 100%;">';
    } else {
      html += '<span style="font-size: 24px; color: #bbb;">ğŸ“¦</span>';
    }
    html += '</div>';
    
    html += '<div class="item-content">';
    html += '<div class="product-name">' + (product.productName || product.name || product.productCode || '') + '</div>';
    html += '<div class="product-code">ç¼–ç : ' + (product.productCode || product.code || '-') + '</div>';
    
    html += '<div class="tags">';
    html += '<span class="tag tag-blue">æ€»åº“å­˜: ' + (product.quantity || 0) + '</span>';
    
    var locationCount = product.locations ? product.locations.length : 0;
    html += '<span class="tag tag-green">åº“ä½: ' + locationCount + '</span>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    
    resultsDiv.innerHTML += html;
  });
}

// æ˜¾ç¤ºå•†å“è¯¦æƒ…
function showProductDetail(index) {
  var product = productsList[index];
  if (!product) return;
  
  var modalContent = document.getElementById('modalContent');
  var html = '';
  
  // å•†å“åŸºæœ¬ä¿¡æ¯
  html += '<div style="display: flex; margin-bottom: 20px;">';
  html += '<div style="width: 80px; height: 80px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; margin-right: 15px;">';
  if (product.image) {
    html += '<img src="' + product.image + '" alt="å•†å“å›¾ç‰‡" style="max-width: 100%; max-height: 100%;">';
  } else {
    html += '<span style="font-size: 24px; color: #bbb;">ğŸ“¦</span>';
  }
  html += '</div>';
  
  html += '<div>';
  html += '<div style="font-size: 18px; font-weight: bold;">' + (product.productName || product.name || product.productCode || '') + '</div>';
  html += '<div style="margin: 5px 0;">ç¼–ç : ' + (product.productCode || product.code || '-') + '</div>';
  html += '<div>å•ä½: ' + (product.unit || 'ä»¶') + '</div>';
  html += '<div style="font-size: 16px; color: #52c41a; margin-top: 5px;">æ€»åº“å­˜: ' + (product.quantity || 0) + '</div>';
  html += '</div>';
  html += '</div>';
  
  // å•†å“SKUä¿¡æ¯
  if (product.variants && product.variants.length > 0) {
    html += '<div class="section-title">SKUæ¬¾å¼</div>';
    
    // æŒ‰å±æ€§åˆ†ç»„ï¼ˆå¦‚é¢œè‰²ï¼‰
    var groupedVariants = {};
    product.variants.forEach(function(variant) {
      var color = variant.attributes && variant.attributes.find(function(attr) { 
        return attr.name === 'color' || attr.name === 'é¢œè‰²';
      });
      
      var colorName = color ? color.value : 'é»˜è®¤';
      
      if (!groupedVariants[colorName]) {
        groupedVariants[colorName] = [];
      }
      
      groupedVariants[colorName].push(variant);
    });
    
    // æ¸²æŸ“åˆ†ç»„åçš„å˜ä½“
    Object.keys(groupedVariants).forEach(function(colorName) {
      html += '<div class="sku-item">';
      html += '<div class="sku-title">' + colorName + '</div>';
      
      html += '<div class="sku-variants">';
      groupedVariants[colorName].forEach(function(variant) {
        var size = variant.attributes && variant.attributes.find(function(attr) { 
          return attr.name === 'size' || attr.name === 'å°ºç ';
        });
        
        var sizeName = size ? size.value : '';
        var skuCode = variant.code || variant.sku || '';
        
        html += '<div class="sku-variant">';
        html += (sizeName || '') + (sizeName && skuCode ? ' (' + skuCode + ')' : skuCode);
        html += ' - ' + (variant.quantity || 0) + (product.unit || 'ä»¶');
        html += '</div>';
      });
      html += '</div>';
      
      html += '</div>';
    });
  } else if (product.skus && product.skus.length > 0) {
    html += '<div class="section-title">SKUæ¬¾å¼</div>';
    
    // æŒ‰é¢œè‰²åˆ†ç»„
    var colorGroups = {};
    product.skus.forEach(function(sku) {
      var fullName = sku.sku || sku.code || '';
      var parts = fullName.split('-');
      
      // å°è¯•ä»SKUç¼–ç ä¸­æå–é¢œè‰²å’Œå°ºç ä¿¡æ¯
      var color = parts.length > 1 ? parts[1] : 'é»˜è®¤';
      var size = parts.length > 2 ? parts[2] : '';
      
      if (!colorGroups[color]) {
        colorGroups[color] = [];
      }
      
      colorGroups[color].push({
        code: fullName,
        size: size,
        quantity: sku.quantity || 0
      });
    });
    
    // æ¸²æŸ“åˆ†ç»„åçš„SKU
    Object.keys(colorGroups).forEach(function(color) {
      html += '<div class="sku-item">';
      html += '<div class="sku-title">' + color + '</div>';
      
      html += '<div class="sku-variants">';
      colorGroups[color].forEach(function(sku) {
        html += '<div class="sku-variant">';
        html += (sku.size || '') + (sku.size && sku.code ? ' (' + sku.code + ')' : sku.code);
        html += ' - ' + (sku.quantity || 0) + (product.unit || 'ä»¶');
        html += '</div>';
      });
      html += '</div>';
      
      html += '</div>';
    });
  }
  
  // åº“ä½ä¿¡æ¯
  if (product.locations && product.locations.length > 0) {
    html += '<div class="section-title">åº“ä½æ˜ç»†</div>';
    
    product.locations.forEach(function(loc) {
      html += '<div class="location-item">';
      html += '<div>';
      html += '<div><strong>åº“ä½: ' + (loc.locationCode || '-') + '</strong></div>';
      html += '<div>' + (loc.locationName || '') + '</div>';
      html += '</div>';
      html += '<div class="location-qty">' + (loc.quantity || 0) + '</div>';
      html += '</div>';
    });
  }
  
  modalContent.innerHTML = html;
  document.getElementById('productModal').style.display = 'block';
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal() {
  document.getElementById('productModal').style.display = 'none';
}

// æœç´¢åŠŸèƒ½
function searchProduct() {
  var searchText = document.getElementById('searchInput').value.trim().toLowerCase();
  if (!searchText) {
    renderProductList(productsList);
    return;
  }
  
  var filtered = productsList.filter(function(item) {
    return (
      (item.productName && item.productName.toLowerCase().includes(searchText)) || 
      (item.name && item.name.toLowerCase().includes(searchText)) ||
      (item.productCode && item.productCode.toLowerCase().includes(searchText)) ||
      (item.code && item.code.toLowerCase().includes(searchText))
    );
  });
  
  if (filtered.length === 0) {
    alert('æœªæ‰¾åˆ°åŒ¹é…çš„å•†å“');
    return;
  }
  
  renderProductList(filtered);
}

// ç›‘å¬å›è½¦
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter' || e.keyCode === 13) {
    searchProduct();
  }
});
</script>
</body>
</html> 